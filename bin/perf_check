#!/usr/bin/env ruby

require 'perf_check'

perf_check = PerfCheck.new
options = perf_check.options
options.login = nil
options.number_of_requests = 10
options.reference = 'master'
options.http_statuses = [200]
options.verify_responses = false
options.caching = true

ORIGINAL_ARGV = ARGV.clone

opts = OptionParser.new do |opts|
  opts.banner = "Usage: perf_check [options] [route ...]"

  opts.separator 'Login options:'
  opts.on('--admin', 'Log in as admin user for route') do
    options.login = :admin
  end

  opts.on('--standard', 'Log in as standard user for route') do
    options.login = :standard
  end

  opts.on('--super', 'Log in as super user') do
    options.login = :super
  end

  opts.on('--user USER', '-u', 'Log in as USER') do |user|
    options.login = user
  end

  opts.on('--no-login', '-L', "Don't log in") do
    options.login = nil
  end

  opts.separator "\nBenchmark options:"
  opts.on('--requests N', '-n',
          'Use N requests in benchmark, defaults to 10') do |n|
    options.number_of_requests = n.to_i
  end

  opts.on('--reference COMMIT', '-r',
          'Benchmark against COMMIT instead of master') do |commit|
    options.reference = commit
  end

  opts.on('--quick', '-q',
          'Fire off 5 requests just on this branch, no comparison with master') do
    options.number_of_requests = 5
    options.reference = nil
  end

  opts.on('--no-caching', 'Do not enable fragment caching') do
    options.caching = false
  end

  opts.on('--fail-fast', '-f', 'Bail immediately on non-200 HTTP response') do
    options[:fail_fast?] = true
  end

  opts.on('--302-success', 'Consider HTTP 302 code a successful request') do
    options.http_statuses.push(302)
  end

  opts.on('--302-failure', 'Consider HTTP 302 code an unsuccessful request') do
    options.http_statuses.delete(302)
  end

  opts.separator "\nMisc"
  opts.on('--input FILE', '-i') do |input|
    File.readlines(input).each do |resource|
      ARGV << resource.strip
    end
  end

  opts.on('--verify-responses',
          'Check whether there is a diff between the responses of this and the reference branch') do
    options.verify_responses = true
  end

  opts.on('--brief', '-b') do
    options.brief = true
  end

  opts.on('--diff') do
    options.diff = true
    options.brief = true
    options.verify_responses = true
    options.number_of_requests = 1
  end

  opts.separator ''
  opts.separator <<EOF
Usage examples:
  Benchmark PostController#index against master
     perf_check /user/45/posts
     perf_check /user/45/posts -n5
     perf_check /user/45/posts --standard
     perf_check /user/45/posts --admin

  Benchmark against a specific commit
     perf_check /user/45/posts -r 0123abcdefg
     perf_check /user/45/posts -r HEAD~2

  Benchmark the changes in the working tree
     perf_check /user/45/posts -r HEAD

  Benchmark and diff the output against master
     perf_check /user/45/posts --verify-responses

  Just diff the output on your branch with master
     perf_check /user/45/posts --diff

  Diff a bunch of urls listed in a file (newline seperated)
    perf_check --diff --input FILE
EOF
end

begin
  opts.parse!

  PerfCheck.require_rails(options)

  ARGV.each do |route|
    perf_check.add_test_case(route)
  end

  if perf_check.test_cases.empty?
    abort(opts.help)
  end

  perf_check.trigger_before_start_callback

  perf_check.sanity_check
  perf_check.run

  if options.brief
    perf_check.print_brief_results
  else
    perf_check.print_results
  end
rescue error
ensure
  cbdata = {}
  if error
    cbdata[:error_message] = "#{error.class}: #{error.message}\n"
    cbdata[:error_message] << error.backtrace.map{|x| "\t#{x}"}.join("\n")
  end
  perf_check.trigger_when_finished_callback(dbdata)
  raise error if error
end

#            _______________________
#           < You made it faster!!! >
#            -----------------------
#           o                             .       .
#            o                           / `.   .' "
#             o                  .---.  <    > <    >  .---.
#              O                 |    \  \ - ~ ~ - /  /    |
#                    _____          ..-~             ~-..-~
#                   |     |   \~~~\.'                    `./~~~/
#                  =========   \__/    R U B Y T U N E     \__/
#                 .'  O    \     /               /       \  "
#                (_____,    `._.'               |         }  \/~~~/
#                 `----.          /       }     |        /    \__/
#                       `-.      |       /      |       /      `. ,~~|
#                           ~-.__|      /_ - ~ ^|      /- _      `..-'
#                                |     /        |     /     ~-.     `-. _  _  _
#                                |_____|        |_____|         ~ - . _ _ _ _ _>
#
