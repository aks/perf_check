#!/usr/bin/env ruby

require 'perf_check'

perf_check = PerfCheck.new
options = perf_check.options

ORIGINAL_ARGV = ARGV.clone

error = nil
begin
  app_root = Dir.pwd
  until app_root == '/' || File.exist?("#{app_root}/config/application.rb")
    app_root = File.dirname(app_root)
  end

  unless File.exist?("#{app_root}/config/application.rb")
    abort("perf_check should be run from a rails directory")
  end

  if File.exists?("#{app_root}/config/perf_check")
    require "#{app_root}/config/perf_check"
  end

  PerfCheck::Options.parse!

  ARGV.grep(/^[^-]/).each do |route|
    perf_check.add_test_case(route)
  end

  if perf_check.test_cases.empty?
    abort(PerfCheck::Options.help)
  end

  perf_check.trigger_before_start_callback

  perf_check.sanity_check
  perf_check.run

  if options.brief
    perf_check.print_brief_results
  else
    perf_check.print_results
  end
rescue Exception => error
ensure
  cbdata = {}
  if error
    cbdata[:error_message] = "#{error.class}: #{error.message}\n"
    cbdata[:error_message] << error.backtrace.map{|x| "\t#{x}"}.join("\n")
  end
  perf_check.trigger_when_finished_callback(cbdata)
  raise error if error
end

#            _______________________
#           < You made it faster!!! >
#            -----------------------
#           o                             .       .
#            o                           / `.   .' "
#             o                  .---.  <    > <    >  .---.
#              O                 |    \  \ - ~ ~ - /  /    |
#                    _____          ..-~             ~-..-~
#                   |     |   \~~~\.'                    `./~~~/
#                  =========   \__/    R U B Y T U N E     \__/
#                 .'  O    \     /               /       \  "
#                (_____,    `._.'               |         }  \/~~~/
#                 `----.          /       }     |        /    \__/
#                       `-.      |       /      |       /      `. ,~~|
#                           ~-.__|      /_ - ~ ^|      /- _      `..-'
#                                |     /        |     /     ~-.     `-. _  _  _
#                                |_____|        |_____|         ~ - . _ _ _ _ _>
#
